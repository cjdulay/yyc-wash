<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="logo.png">
  <link rel="apple-touch-icon" href="logo.png">
  <title>YYC CAR WASH FORECASTER</title>
  <style>
    :root { --bg: #0f172a; --card: #ffffff; --accent: #1e293b; --blue: #0284c7; --red: #e11d48; --gold: #fbbf24; --green: #059669; --indigo: #4338ca; }
    body { font-family: -apple-system, system-ui, sans-serif; margin: 0; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; transition: background 0.6s ease; overscroll-behavior-y: contain; position: relative;}
     /* This adds the film grain over the whole screen */
    body::after {
    content: "";
    position: fixed;
    overflow: hidden;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    opacity: 0.06; 
    pointer-events: none; 
    z-index: 9999; 
}

    #card { 
    background: var(--card); 
    width: 92%; 
    position: relative;
    max-width: 400px; 
    border-radius: 40px; 
    touch-action: none;
    overflow: hidden; 
    display: none; 
    box-shadow: 0 30px 60px rgba(0,0,0,0.6); 
    
    
    /* REFINEMENT: Smooth movement and "rubber-band" snap back */
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.3s ease;
    will-change: transform; /* Optimizes performance for mobile processors */
}

/* REFINEMENT: Visual look when the sync is happening */
.syncing {
    opacity: 0.6;
    transform: scale(0.96) !important;
}
    
    .final-verdict-ribbon { padding: 12px; text-align: center; font-weight: 900; font-size: 0.85em; letter-spacing: 2px; text-transform: uppercase; color: white; }
    .v-yes { background: var(--green); }
    .v-no { background: var(--blue); }
    .v-wait { background: #475569; }
    .v-slush { background: #92400e; }

    .header { padding: 30px 20px 15px; text-align: center; }
    .badge { font-size: 2.8em; font-weight: 900; margin: 5px 0; letter-spacing: -1.5px; }
    .cur-temp-sub { font-size: 1.1em; font-weight: 800; color: #64748b; margin-bottom: 8px; }
    .judgement-call-text { font-size: 0.85em; font-weight: 600; line-height: 1.4; color: #475569; padding: 0 10px; }
    .maintenance-nag { color: var(--red); font-weight: 800; display: block; margin-top: 5px; text-transform: uppercase; font-size: 0.75em; }

    .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 0 20px 15px; }
    .tile { background: #f1f5f9; padding: 15px; border-radius: 26px; text-align: center; border: 1px solid #e2e8f0; cursor: pointer; transition: transform 0.1s; }
    .tile:active { transform: scale(0.96); }
    .stat-label { font-size: 0.65em; font-weight: 800; color: #64748b; text-transform: uppercase; display: block; margin-bottom: 4px; }
    .stat-val { font-size: 0.95em; font-weight: 700; color: #0f172a; }
    .tile-wide { grid-column: span 2; background: #fffbeb; border-color: #fde68a; }

    .drawer { display: none; background: #0f172a; color: #f1f5f9; margin: 0 20px 15px; padding: 22px; border-radius: 26px; font-size: 0.85em; line-height: 1.6; border: 1px solid #334155; text-align: left; }
    .drawer b { color: var(--gold); }

    .alerts-area { padding: 0 20px 15px; text-align: left; }
    .banner { border-radius: 22px; padding: 14px 18px; margin-bottom: 8px; display: none; align-items: center; gap: 12px; cursor: pointer; position: relative; }
    .b-info { flex-grow: 1; text-align: left; }
    .btn-action-label { font-size: 0.62em; background: rgba(255,255,255,0.25); padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: inline-block; font-weight: bold; }
    .alert-drawer { display: none; padding-top: 10px; border-top: 1px solid rgba(0,0,0,0.1); margin-top: 8px; font-size: 0.85em; line-height: 1.5; }

    .blue { background: #e0f2fe; color: #0369a1; }
    .orange { background: #fef3c7; color: #b45309; }
    .indigo { background: #e0e7ff; color: #4338ca; }

    .info-trigger { background: #334155; color: white; border-radius: 50%; width: 16px; height: 16px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7em; cursor: pointer; margin-left: 4px; font-weight: bold; position: relative; top: -1px; }
    .info-drawer { display: none; background: #1e293b; color: #cbd5e1; margin: 10px 0; padding: 15px; border-radius: 18px; font-size: 0.82em; border: 1px dashed #475569; }

    #forecast { display: flex; margin: 0 20px 20px; background: #f8fafc; padding: 12px; border-radius: 28px; border: 1px solid #f1f5f9; }
    .fact-box { margin: 0 20px 20px; padding: 18px; background: #f1f5f9; border-radius: 24px; border-left: 5px solid var(--gold); font-size: 0.82em; line-height: 1.4; color: #1e293b; text-align: left; }

    .action-container { padding: 0 20px 30px; display: flex; justify-content: center; }
    .btn { border: none; font-weight: 800; cursor: pointer; border-radius: 26px; text-align: center; transition: all 0.2s; }
    .btn-refresh { background: #1e293b; color: white; width: 100%; padding: 22px; font-size: 1.1em; box-shadow: 0 10px 25px rgba(30, 41, 59, 0.2); }
    .btn-log { background: #334155; color: #f1f5f9; width: auto; min-width: 140px; margin: 15px auto 0; padding: 10px 20px; font-size: 0.8em; display: block; }
    
    .footer { font-size: 0.7em; color: #94a3b8; padding-bottom: 25px; text-align: center; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; }
    
    #ios-prompt { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: white; color: #333; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: none; z-index: 9999; border: 1px solid #ddd; } .ios-icon { width: 20px; vertical-align: middle; }
    #weather-link:active { transform: scale(0.97); opacity: 0.8; transition: transform 0.1s; } #weather-link { -webkit-tap-highlight-color: transparent; touch-action: manipulation; position: relative; }
    
     overscroll-behavior-y: contain;
     
     .orange { background: #fff7ed; color: #9a3412; border: 1px solid #fed7aa; } /* CHIP RISK (Clay) */
     .amber { background: #fffbeb; color: #92400e; border: 1px solid #fde68a; }  /* RUST RISK (Chemical) */
     .banner { display: none; align-items: center; gap: 12px; padding: 14px 18px; border-radius: 22px; margin: 0 20px 8px; cursor: pointer; }

  </style>
</head>
<body>

<div id="ios-prompt">
  <p><strong>Install YYC Wash:</strong> Tap the <img src="https://upload.wikimedia.org/wikipedia/commons/d/d3/IOS7_Export_Icon.png" class="ios-icon"> button below and select <strong>"Add to Home Screen"</strong>.</p>
  <button onclick="document.getElementById('ios-prompt').style.display='none'" style="border:none; background:none; color:#007aff; font-weight:bold; float:right;">Close</button>
</div>

<div id="card">
  <div id="final-verdict" class="final-verdict-ribbon">VERDICT: --</div>

  <div class="header">
    <div id="sync-tag" style="font-size: 0.6em; font-weight: 900; color: #94a3b8; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 1px;">
        YYC SENSOR ‚Ä¢ SYNCING...
    </div>
    
    <div id="status-badge" class="badge">--</div>
    <div id="cur-temp-display" class="cur-temp-sub">--&deg;C Currently</div>
    <div id="judgement-call" class="judgement-call-text">--</div>
    <div id="maintenance-nag" class="maintenance-nag" style="display:none;">‚ö†Ô∏è WASH OVERDUE: 7+ DAYS</div>
  </div>
  

  <div class="dashboard-grid">
    <div class="tile" onclick="toggleElement('salt-drawer')">
      <span class="stat-label">ROAD CHEMISTRY</span>
      <span id="salt-val" class="stat-val">--</span> <span style="font-size:0.7em; color:#94a3b8;">‚ñº</span>
    </div>
    <div class="tile" onclick="toggleElement('log-drawer')">
      <span class="stat-label">WASH LOGS</span>
      <span id="last-date" class="stat-val">None</span> <span style="font-size:0.7em; color:#94a3b8;">‚ñº</span>
    </div>
    <div class="tile tile-wide" onclick="toggleElement('verdict-drawer')">
      <span class="stat-label">STRATEGIC OPENING</span>
      <span id="next-val" class="stat-val">--</span> <span style="font-size:0.7em; color:#94a3b8;">‚ñº</span>
    </div>
  </div>

  <div id="salt-drawer" class="drawer">
    <span id="salt-logic-text">--</span><br><br>
    <b>Brake Care:</b> Hybrids rely heavily on regenerative braking. In YYC winters, salt can cause the mechanical pads to seize from lack of use. Rinse calipers thoroughly and engage friction brakes occasionally.
  </div>
  
  <div id="log-drawer" class="drawer">
    <div style="font-weight:bold; border-bottom:1px solid #334155; padding-bottom:8px; margin-bottom:8px;">üöó History (Last 5)</div>
    <div id="log-list">No entries logged.</div>
    <button class="btn btn-log" onclick="addNewWash()">+ LOG NEW WASH</button>
  </div>

  <div id="verdict-drawer" class="drawer">
    <b>üìã Opening Analysis:</b><br>
    <span id="verdict-text">--</span><br><br>
    <b>The "Lag" Rule:</b> Your car's chassis stays frozen much longer than the air. Driving for 15+ minutes before a wash warms the steel, helping prevent water from flash-freezing on contact.
  </div>

<div class="alerts-area">
  <div id="fluid-alert" class="banner orange" onclick="toggleElement('fluid-drawer')">
    <span>üå´Ô∏è</span>
    <div class="b-info">
      <span style="font-weight:800;">VISIBILITY: HIGH SALT-FILM</span><br>
      <span style="font-size:0.7em;">Peak Washer Fluid Usage ‚ñº</span>
      <div id="fluid-drawer" class="alert-drawer">
        "Dry salt spray" is at its peak. You will likely use 3x more washer fluid today than usual. Ensure your reservoir is topped with -40¬∞C rated fluid.
      </div>
    </div>
  </div>

  <div id="ice-alert" class="banner indigo" onclick="toggleElement('ice-drawer')">
    <span>üßä</span>
    <div class="b-info">
      <span style="font-weight:800;">SAFETY: BLACK ICE RISK</span><br>
      <span style="font-size:0.7em;">Invisible Surface Glaze ‚ñº</span>
      <div id="ice-drawer" class="alert-drawer">
        Roads may look wet but offer no tire spray. Watch for "invisible" glaze on bridges and shadowed turns. Avoid cruise control.
      </div>
    </div>
  </div>

  <div id="plugin-alert" class="banner blue" onclick="toggleElement('plugin-drawer')">
    <span>üîå</span>
    <div class="b-info">
      <span style="font-weight:800;">ENGINE: PLUG-IN REQUIRED</span><br>
      <span style="font-size:0.7em;">Temp below -20¬∞C detected ‚ñº</span>
      <div id="plugin-drawer" class="alert-drawer">
        Extreme cold detected. Plug in your block heater for at least 3-4 hours to reduce engine strain and battery drain.
      </div>
    </div>
  </div>

  <div id="regen-alert" class="banner indigo" onclick="toggleElement('regen-drawer')">
    <span>üîã</span>
    <div class="b-info">
      <span style="font-weight:800;">DRIVING: REGEN LIMITED</span><br>
      <span style="font-size:0.7em;">Battery too cold for intake ‚ñº</span>
      <div id="regen-drawer" class="alert-drawer">
        Your battery management system (BMS) will limit regenerative braking to protect the cells. Expect to use your physical brake pedal more than usual.
      </div>
    </div>
  </div>

  <div id="rust-alert" class="banner amber" onclick="toggleElement('rust-drawer')">
    <span>üß™</span>
    <div class="b-info">
      <span style="font-weight:800;">CHASSIS: PEAK CORROSION</span><br>
      <span style="font-size:0.7em;">Salt is chemically active ‚ñº</span>
      <div id="rust-drawer" class="alert-drawer">
        At these temperatures, road salt forms a liquid brine that accelerates oxidation. <b>Liquid salt eats steel.</b> An undercarriage rinse is mandatory.
      </div>
    </div>
  </div>

  <div id="freeze-alert" class="banner blue" onclick="toggleElement('freeze-drawer')">
    <span>‚è±Ô∏è</span>
    <div class="b-info">
      <span style="font-weight:800;">MAINTENANCE: DRYING WINDOW</span><br>
      <span id="freeze-val" style="font-size:0.7em; font-weight:800;">-- MIN UNTIL FREEZE ‚ñº</span>
      <span class="info-trigger" onclick="event.stopPropagation(); toggleElement('window-info')">i</span>
      <div id="window-info" class="info-drawer">
          <b>Drying Window:</b> Your countdown to dry rubber seals before they freeze shut. Wind chill acts as a heat sink that bonds ice to your frame in minutes.
      </div>
      <div id="freeze-drawer" class="alert-drawer">
        Wipe door jambs immediately. Apply silicone spray to weatherstripping to prevent the rubber from bonding to the frame.
      </div>
    </div>
  </div>

  <div id="chip-alert" class="banner orange" onclick="toggleElement('chip-drawer')">
    <span>üíé</span>
    <div class="b-info">
      <span style="font-weight:800;">DAMAGE: HIGH CHIP RISK</span><br>
      <span style="font-size:0.7em;">Pickle Sand in Use ‚ñº</span>
      <div id="chip-drawer" class="alert-drawer">
        Calgary uses "Pickle" (97% gravel). Increase following distance to 4+ seconds. Avoid brushes on dry salt-crust to avoid scratching the clear-coat.
      </div>
    </div>
  </div>
</div>

 <a href="#" id="weather-link" style="text-decoration: none; color: inherit; display: block; -webkit-tap-highlight-color: transparent;">
  <div id="forecast" style="display:flex;gap:10px;margin-top:15px;overflow-x:auto;padding-bottom:5px;">
    </div>
</a>

  <div class="fact-box">
    <div style="font-weight:900; color:var(--gold); font-size:0.75em; text-transform:uppercase; margin-bottom:6px; letter-spacing:1px;">YYC Insider Insight</div>
    <div id="random-fact">--</div>
  </div>

  <div id="sync-footer" class="footer">YYC CAR WASH FORECASTER </div>
</div>

<script>
const yycInsights = [
  "<b>HYBRID TIP:</b> At -19¬∞C, regen braking is limited because the BMS restricts power intake until the battery cells warm up.",
  "<b>WIPER TIP:</b> Wipe blades with winter fluid after a wash. This removes residue that causes them to freeze to the windshield.",
  "<b>FLUID TIP:</b> Only use washer fluid rated for -40¬∞C. Summer fluids will freeze and crack your reservoir in a Calgary snap.",
  "<b>YYC FACT:</b> 'Pickle' mixture is 97% gravel and 3% salt. Salt is inert below -15¬∞C, making sand the primary grip provider.",
  "<b>CHINOOK FACT:</b> A rapid thaw creates 'Active Slush'‚Äîthe most corrosive road state. Wait for dry roads before washing.",
  "<b>THERMAL TIP:</b> Pre-heat your interior before a wash. This warms the glass and reduces thermal shock when wash water hits.",
  "<b>DID YOU KNOW:</b> In cold weather, you lose about 1 PSI for every 10¬∞C temperature drop. Check your tire pressure regularly.",
  "<b>CHINOOK TIP:</b> Rapid thaws cause 'Concrete Sweating' in parkades. Brakes can flash-rust even if you don't drive outside.",
  "<b>LOCK TIP:</b> Avoid high-pressure spray directly into door handles at -15¬∞C. Use painter's tape to cover keyholes if washing.",
  "<b>MAG-CHLORIDE FACT:</b> Calgary uses 'Mag-Brine' on Deerfoot. It's stickier than rock salt and needs a high-pressure rinse to remove.",
  "<b>BATTERY TIP:</b> Cold cranking amps drop 50% at -18¬∞C. Don't leave your lights on while wiping down after a wash!",
  "<b>CHASSIS THERMALS:</b> Steel stays cold longer than air. If it was -20¬∞C all night, your car is a 'heat sink' even if it's -2¬∞C now.",
  "<b>WIPER TIP:</b> After a wash, lift your wipers. Water trapped in the rubber pivot will freeze them in the 'down' position.",
  "<b>CHINOOK TIP:</b> Rapid thaws cause 'Concrete Sweating' in parkades. Brakes can flash-rust even if you don't drive outside.",
  "<b>BEET JUICE FACT:</b> Calgary uses 'Beet 55' brine. The sugar molasses helps salt stick to the road down to -26¬∞C, but it creates a sticky brown film on your car that requires soap to break down.",
  "<b>GARAGE WARNING:</b> Parking in a heated garage 'wakes up' frozen salt. Rusting happens 10x faster at room temperature than in the freezing cold. Wash before parking inside!",
  "<b>MAG-CHLORIDE FACT:</b> Calgary uses liquid Mag-Brine on Deerfoot. It is more corrosive than rock salt and stays wet longer, eating at your brake lines.",
  "<b>LOCK TIP:</b> Avoid high-pressure spray directly into door handles at -15¬∞C. Water forced into the tumbler will leave you locked out by morning.",
];


function toggleElement(id) {
  const target = document.getElementById(id);
  const isOpen = target.style.display === 'block';
  target.style.display = isOpen ? 'none' : 'block';
}

function addNewWash() {
  let h = JSON.parse(localStorage.getItem('washLogV2') || "[]");
  h.unshift(new Date().toISOString());
  if (h.length > 5) h.pop();
  localStorage.setItem('washLogV2', JSON.stringify(h));
  updateUI();
}

function undoWash() {
  let h = JSON.parse(localStorage.getItem('washLogV2') || "[]");
  if (h.length > 0) {
    h.shift();
    localStorage.setItem('washLogV2', JSON.stringify(h));
    updateUI();
  }
}

function updateUI() {
  const h = JSON.parse(localStorage.getItem('washLogV2') || "[]");
  const list = document.getElementById('log-list');
  const lastDate = document.getElementById('last-date');
  const nag = document.getElementById('maintenance-nag');
  
  if (h.length > 0) {
    const lastWashDate = new Date(h[0]);
    lastDate.innerText = lastWashDate.toLocaleDateString('en-CA', {month:'short', day:'numeric'});
    const daysSince = Math.floor((new Date() - lastWashDate) / (1000 * 60 * 60 * 24));
    nag.style.display = (daysSince >= 7) ? 'block' : 'none';
    nag.innerText = `‚ö†Ô∏è WASH OVERDUE: ${daysSince} DAYS`;

    list.innerHTML = h.map((item, idx) => {
      const d = new Date(item);
      return `<div style="padding:6px 0; border-bottom:1px solid #334155; display:flex; justify-content:space-between; align-items:center;">
        <span>üìÖ ${d.toLocaleDateString('en-CA', {month:'short', day:'numeric'})} ${d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
        ${idx === 0 ? '<span onclick="undoWash()" style="color:#f43f5e; font-weight:bold; cursor:pointer; font-size:0.9em;">Undo</span>' : ''}
      </div>`;
    }).join('');
  } else {
    lastDate.innerText = "None";
    list.innerHTML = "No entries logged.";
    nag.style.display = 'none';
  }
}

async function updateWeather() {
  document.getElementById('sync-tag').innerText = "YYC SENSOR ‚Ä¢ SYNCING...";
  
  const url = "https://api.open-meteo.com/v1/forecast?latitude=51.05&longitude=-114.07&daily=temperature_2m_max,precipitation_sum&hourly=precipitation,temperature_2m,wind_speed_10m&timezone=America/Edmonton&past_days=1";
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    const curHr = 24 + new Date().getHours();
    const curTemp = data.hourly.temperature_2m[curHr];
    const wind = data.hourly.wind_speed_10m[curHr];
    const tToday = data.daily.temperature_2m_max[1];
    const tYesterday = data.daily.temperature_2m_max[0];
    const precToday = data.daily.precipitation_sum[1] || 0;
    const precYesterday = data.daily.precipitation_sum[0] || 0;

    document.getElementById('cur-temp-display').innerText = Math.round(curTemp) + "¬∞C Currently";

    // 1. Define the rules (The "Brain")
    let isSaltySlush = (curTemp >= -5 && curTemp <= 3 && (precToday > 0.1 || precYesterday > 0.1));
    let isChinookThaw = (curTemp > -2 && tYesterday < -10);
    let roadIsWet = (tToday > 0 || tYesterday > 0);
    let isRefreezing = (curTemp <= 1 && roadIsWet);
    
    // 2. Set default values
    let vText = "WAIT", vCol = "var(--accent)", status = "üîµ NEUTRAL", vc = "v-no";
    let judgement = "Roads are clear, but washing is risky.";

    // 3. Show/Hide the Ice Alert banner
    document.getElementById('ice-alert').style.display = isRefreezing ? 'flex' : 'none';

    // 4. The Decision Tree
    if (curTemp < -12 || tToday < -10) {
        vText = "NO GO: FREEZE RISK"; 
        vCol = "var(--blue)"; 
        status = "‚ùÑÔ∏è TOO COLD";
        judgement = curTemp <= -17 ? "<b>Salt is dead.</b> City is using sand. Low rust risk, but door seals will freeze shut." : "Salt is inactive. Risk of frozen handles outweighs the benefit.";
    } 
    else if (isSaltySlush || isChinookThaw) {
        vText = "WAIT: SALTY SLUSH"; 
        vCol = "#92400e"; 
        status = "üöú ROADS ARE MESSY"; 
        vc = "v-slush";
        judgement = "Roads are a <b>river of brown slush.</b> Washing now is a waste of money; you will be coated in salt in minutes.";
    } 
    else if (curTemp > -5) {
        vText = "GO: PERFECT CONDITIONS"; 
        vCol = "var(--green)"; 
        status = "üöø WASH NOW"; 
        vc = "v-yes";
        judgement = "Safe window found. Roads are dry. Rinse that salt before the next deep freeze!";
    }

    // Update UI Elements
    const rib = document.getElementById('final-verdict');
    rib.innerText = vText; 
    rib.style.backgroundColor = vCol;
    document.body.style.backgroundColor = vCol;
    document.getElementById('status-badge').innerText = status;
    document.getElementById('status-badge').style.color = vCol;
    document.getElementById('judgement-call').innerHTML = judgement;

    // Road Chemistry Logic
    let sI = "Active Brine";
    if (curTemp <= -15) sI = "Extreme (Pickle)";
    else if (curTemp > 0) sI = "Wet/Diluted";
    document.getElementById('salt-val').innerText = sI;
    document.getElementById('salt-logic-text').innerHTML = `<b>üß™ ${sI}:</b> Current road state based on ${curTemp}¬∞C chemistry.`;

    // Random Insight
    document.getElementById('random-fact').innerHTML = yycInsights[Math.floor(Math.random() * yycInsights.length)];

    // --- ALERTS TRIGGER SYSTEM ---
    
    // 1. Engine/Driving Alerts
    document.getElementById('plugin-alert').style.display = (curTemp <= -20) ? 'flex' : 'none';
    document.getElementById('regen-alert').style.display = (curTemp <= -15) ? 'flex' : 'none';
    
    // 2. Visibility & Road Alerts
    document.getElementById('fluid-alert').style.display = (curTemp < -8 && curTemp > -16) ? 'flex' : 'none';
    document.getElementById('chip-alert').style.display = (curTemp < -14) ? 'flex' : 'none';
    document.getElementById('rust-alert').style.display = (curTemp > -4 && curTemp < 2) ? 'flex' : 'none';
    document.getElementById('ice-alert').style.display = (curTemp <= 1 && (tToday > 0 || tYesterday > 0)) ? 'flex' : 'none';

    // 3. Maintenance (Drying Window) Alert
    if (curTemp < 0) {
        let freezeTime = Math.max(3, Math.round(20 + (curTemp * 1.5) - (wind * 0.4)));
        if (tYesterday < -15 && freezeTime > 8) freezeTime = 8;
        // This matches your new revised label format
        document.getElementById('freeze-val').innerText = `${freezeTime} min until freeze ‚ñº`;
        document.getElementById('freeze-alert').style.display = 'flex';
    } else {
        document.getElementById('freeze-alert').style.display = 'none';
    }

    // --- STRATEGIC OPENING CALCULATION ---
    for (let k = 2; k < 9; k++) {
      if (data.daily.temperature_2m_max[k] > -6 && data.daily.precipitation_sum[k] < 0.1) {
        const dFull = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][new Date(data.daily.time[k]+"T00:00:00").getDay()];
        document.getElementById('next-val').innerText = dFull;
        document.getElementById('verdict-text').innerHTML = `<b>${dFull}</b> is the best target. It avoids peak melt-slush.`;
        break;
      }
    }
    
    
    // Build Forecast HTML
    let fH = ""; 
    for (let j = 1; j < 6; j++) {
      const dayDate = data.daily.time[j];
      const dayName = (j === 1) ? "Today" : ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(dayDate + "T00:00:00").getDay()];
      const dailyPrec = data.daily.precipitation_sum[j] || 0;
      const dailyTemp = Math.round(data.daily.temperature_2m_max[j]);
      
      fH += `<div style="flex:1;text-align:center;">
          <div style="font-size:0.6em;font-weight:900;color:#94a3b8;">${dayName}</div>
          <div style="font-size:1.1em;margin:5px 0;">${dailyPrec > 0.1 ? '‚ùÑÔ∏è' : '‚òÄÔ∏è'}</div>
          <div style="font-size:0.8em;font-weight:900;">${dailyTemp}¬∞</div>
        </div>`;
    }
    document.getElementById('forecast').innerHTML = fH;

    // --- FINISH LINE ---
    const now = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    document.getElementById('sync-tag').innerText = "YYC SENSOR ‚Ä¢ UPDATED: " + now;

   // ADD THIS LINE FOR HAPTIC FEEDBACK
    if (navigator.vibrate) navigator.vibrate(15); // A crisp 15ms "tap"

    document.getElementById('card').style.display = 'block';
    updateUI();

  } catch (e) { 
    console.error("Weather Update Failed:", e);
    document.getElementById('sync-tag').innerText = "YYC SENSOR ‚Ä¢ SYNC ERROR";
  }
}



updateWeather();

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js')
      .then(() => console.log("Manager (Service Worker) Registered"))
      .catch((err) => console.log("Manager Failed:", err));
  }
  // Detect if device is iOS and not yet installed
const isIos = () => {
  const userAgent = window.navigator.userAgent.toLowerCase();
  return /iphone|ipad|ipod/.test(userAgent);
}

// Check if app is already running in standalone (app) mode
const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

// Show prompt if on iOS and not in standalone mode
if (isIos() && !isInStandaloneMode()) {
  document.getElementById('ios-prompt').style.display = 'block';
}

document.getElementById('weather-link').addEventListener('click', (e) => {
  e.preventDefault();
  const ua = navigator.userAgent.toLowerCase();
  
  // Calgary coordinates for precise local loading
  const lat = 51.0447;
  const lon = -114.0719;
  const fallback = `https://weather.com/weather/today/l/${lat},${lon}`;

  if (ua.includes("iphone") || ua.includes("ipad")) {
    // iOS: Open native Apple Weather via Universal Link
    window.location.href = `https://weather.apple.com/?lat=${lat}&lon=${lon}`;
  } 
  else if (ua.includes("android")) {
    // Android: Direct Intent to Google Weather Card
    window.location.href = "intent://com.google.android.googlequicksearchbox.Weather/#Intent;scheme=http;package=com.google.android.googlequicksearchbox;S.browser_fallback_url=" + encodeURIComponent(fallback) + ";end";
  } 
  else {
    // Desktop: Fallback to high-quality weather site
    window.open(fallback, "_blank");
  }
});

// --- UPGRADED INTERACTION ---
let touchStartY = 0;
const card = document.getElementById('card');

document.addEventListener('touchstart', e => {
    touchStartY = e.touches[0].pageY;
}, {passive: false});

document.addEventListener('touchmove', e => {
    const touchCurrentY = e.touches[0].pageY;
    const distance = touchCurrentY - touchStartY;

    if (window.scrollY === 0 && distance > 0) {
        // Drag the card down slightly as the user pulls (max 30px)
        const pullFactor = Math.min(distance / 5, 30);
        card.style.transform = `translateY(${pullFactor}px)`;
    }
}, {passive: true});

document.addEventListener('touchend', e => {
    const distance = e.changedTouches[0].pageY - touchStartY;

    if (window.scrollY === 0 && distance > 150) {
        // 1. Visual feedback
        card.classList.add('syncing');
        
        // 2. Run the update function without reloading the page
        updateWeather().then(() => {
            // 3. Snap back when data is ready
            setTimeout(() => {
                card.classList.remove('syncing');
                card.style.transform = "translateY(0)";
            }, 500);
        });
    } else {
        // Snap back if they didn't pull far enough
        card.style.transform = "translateY(0)";
    }
}, {passive: true});



</script>
</body>
</html>
