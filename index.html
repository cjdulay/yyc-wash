<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>YYC CAR WASH FORECASTER</title>
  <link rel="icon" href="https://img.icons8.com/fluency/96/car-wash.png">
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #333; transition: background 0.5s; }
    #card { background: white; width: 94%; max-width: 380px; border-radius: 35px; box-shadow: 0 25px 50px rgba(0,0,0,0.3); text-align: center; overflow: hidden; display: none; }
    .header { padding: 25px 15px 10px; }
    .badge { font-size: 2.2em; font-weight: 900; margin: 5px 0; }
    .salt-pill { font-size: 0.65em; font-weight: bold; background: #eee; padding: 5px 12px; border-radius: 20px; display: inline-block; margin-bottom: 10px; text-transform: uppercase; border: 1px solid #ddd; }
    .box { background: #f1f3f5; border-radius: 20px; padding: 18px; margin: 0 20px 12px; font-size: 1.1em; font-weight: 500; }
    #slush-alert { display: none; background: #fff5f5; color: #c92a2a; border: 1px solid #ffc9c9; border-radius: 12px; padding: 12px; margin: 0 20px 12px; font-size: 0.9em; font-weight: bold; text-align: left; }
    #forecast { display: flex; margin: 0 20px 12px; background: #e9ecef; padding: 10px; border-radius: 20px; }
    .history-card { background: #f8f9fa; margin: 0 20px 15px; padding: 12px; border-radius: 20px; font-size: 0.85em; text-align: left; border: 1px solid #eee; position: relative; }
    .undo-link { color: #fa5252; font-size: 0.8em; text-decoration: underline; cursor: pointer; float: right; font-weight: bold; }
    .btn { background: #212529; color: white; border: none; padding: 18px; border-radius: 50px; font-size: 1.1em; font-weight: bold; width: 85%; margin-bottom: 10px; cursor: pointer; }
    .footer { font-size: 0.7em; color: #adb5bd; padding-bottom: 20px; font-weight: bold; }
  </style>
</head>
<body>

<div id="loading" style="color:white; font-weight:bold;">Calgary Weather Scan...</div>

<div id="card">
  <div class="header">
    <div id="salt-pill" class="salt-pill">SALT INTENSITY: --</div>
    <div style="font-size:0.7em;font-weight:900;color:#adb5bd;letter-spacing:1px;text-transform:uppercase;">YYC Car Wash Forecaster</div>
    <div id="status-badge" class="badge">--</div>
  </div>
  
  <div class="history-card">
    <span class="undo-link" onclick="undoWash()">Undo</span>
    <div style="font-weight:bold;color:#888;text-transform:uppercase;font-size:0.75em;margin-bottom:5px;">Wash History</div>
    <div id="history-list">No history.</div>
  </div>

  <div id="slush-alert">üöú ACTIVE SLUSH: Fresh road brine detected.</div>
  <div id="reason-box" class="box">--</div>
  <div id="forecast"></div>
  <div id="next-window" style="font-size: 0.9em; color: #495057; background: #fff9db; margin: 0 20px 15px; padding: 12px; border-radius: 18px; border: 1px dashed #fab005;"></div>
  
  <button class="btn" onclick="location.reload()">REFRESH DATA</button>
  <button class="btn" style="background:#e9ecef; color:#495057; margin-bottom:20px;" onclick="logWash()">üöø LOG A WASH</button>
  <div id="footer-text" class="footer">--</div>
</div>

<script>
function cleanLegacyData() {
  let raw = localStorage.getItem('washHistory');
  if (raw && (raw.includes('undefined') || !raw.startsWith('['))) { localStorage.removeItem('washHistory'); }
}

function logWash() {
  let history = JSON.parse(localStorage.getItem('washHistory') || "[]");
  const dateStr = new Date().toLocaleDateString('en-CA') + " " + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  history.unshift({label: dateStr, time: new Date().getTime()}); 
  if (history.length > 3) history.pop();
  localStorage.setItem('washHistory', JSON.stringify(history));
  updateUI();
}

function undoWash() {
  let history = JSON.parse(localStorage.getItem('washHistory') || "[]");
  if (history.length > 0 && confirm("Delete last wash?")) {
    history.shift();
    localStorage.setItem('washHistory', JSON.stringify(history));
    updateUI();
  }
}

function updateUI() {
  cleanLegacyData();
  const history = JSON.parse(localStorage.getItem('washHistory') || "[]");
  const list = document.getElementById('history-list');
  list.innerHTML = history.length === 0 ? "No recent washes logged." : history.map(item => `<div style="border-bottom: 1px solid #eee; padding: 6px 0;">üìÖ ${item.label}</div>`).join('');
}

async function updateWeather() {
  const url = "https://api.open-meteo.com/v1/forecast?latitude=51.05&longitude=-114.07&daily=temperature_2m_max,temperature_2m_min,precipitation_sum&hourly=precipitation,temperature_2m&timezone=auto&past_days=1&models=gem_seamless";
  
  try {
    const response = await fetch(url);
    const data = await response.json();
    const h = data.hourly;
    const curHr = new Date().getHours();
    const curTemp = h.temperature_2m[curHr];

    // 1. FRESH SLUSH LOGIC
    let freshSnow = 0;
    for (let k = Math.max(0, curHr - 6); k <= curHr; k++) { freshSnow += h.precipitation[k]; }
    const isSlushy = freshSnow >= 0.5 && curTemp > -15.0;
    if (isSlushy) document.getElementById('slush-alert').style.display = 'block';

    // 2. CALGARY SALT INTENSITY
    let sInt = "Low", sCol = "#adb5bd";
    if (curTemp <= 0 && curTemp > -10) { sInt = "High (Brine)"; sCol = "#fab005"; }
    else if (curTemp <= -10 && curTemp >= -16) { sInt = "EXTREME (Calcium)"; sCol = "#fa5252"; }
    document.getElementById('salt-pill').innerText = "SALT INTENSITY: " + sInt;
    document.getElementById('salt-pill').style.color = sCol;

    // 3. MAIN STATUS
    const tToday = parseFloat(data.daily.temperature_2m_max[0]);
    const precipNext2Days = parseFloat(data.daily.precipitation_sum[1]) + parseFloat(data.daily.precipitation_sum[2]);
    let status = "üü¢ WASH NOW", color = "#12b886", icon = "üöø", reason = "Roads are drying. Perfect window!";

    if (tToday < -10) { status = "üîµ TOO COLD"; color = "#228be6"; icon = "üßä"; reason = `High of ${tToday}¬∞C. Water will freeze instantly.`; }
    else if (precipNext2Days > 0.5) { status = "üî¥ SNOW SOON"; color = "#fa5252"; icon = "‚ùÑÔ∏è"; reason = "Snow within 48h. A wash is a waste of money!"; }
    else if (isSlushy) { status = "üöú SLUSH ALERT"; color = "#607d8b"; icon = "üöú"; reason = "Fresh snow + road chemicals = heavy slush splatter."; }

    document.body.style.backgroundColor = color;
    document.getElementById('status-badge').innerHTML = `${icon} ${status}`;
    document.getElementById('status-badge').style.color = color;
    document.getElementById('reason-box').innerText = reason;

    // 4. FORECAST STRIP
    let fH = "";
    for (let j = 0; j < 5; j++) {
      const day = (j === 0) ? "Today" : ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][new Date(data.daily.time[j]+"T00:00:00").getDay()];
      fH += `<div style="flex:1;background:rgba(255,255,255,0.2);margin:2px;padding:8px;border-radius:15px;"><div style="font-size:0.7em;font-weight:bold;">${day}</div><div style="font-size:1.1em;">${data.daily.precipitation_sum[j] > 0.5 ? '‚ùÑÔ∏è' : '‚òÄÔ∏è'}</div><div style="font-size:0.9em;font-weight:bold;">${Math.round(data.daily.temperature_2m_max[j])}¬∞</div></div>`;
    }
    document.getElementById('forecast').innerHTML = fH;
    document.getElementById('next-window').innerHTML = "üóìÔ∏è Next Window: Sun (-1¬∞C)";
    document.getElementById('loading').style.display = 'none';
    document.getElementById('card').style.display = 'block';
    updateUI();
  } catch (e) { document.getElementById('loading').innerText = "Network Error."; }
}
updateWeather();
</script>
</
body>
</html>
